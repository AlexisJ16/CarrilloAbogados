# ===========================================
# ðŸ“Š Prometheus Configuration
# Carrillo Abogados - Metrics Collection
# ===========================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'carrillo-dev'
    env: 'development'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules once and periodically evaluate them
rule_files:
  - /etc/prometheus/rules/*.yml

# Remote write to Mimir for long-term storage
remote_write:
  - url: http://mimir:9009/api/v1/push

# Scrape configs
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # API Gateway (no context-path)
  - job_name: 'api-gateway'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['api-gateway:8080']
        labels:
          group: 'carrillo-backend'
          service: 'api-gateway'

  # Client Service
  - job_name: 'client-service'
    metrics_path: '/client-service/actuator/prometheus'
    static_configs:
      - targets: ['client-service:8200']
        labels:
          group: 'carrillo-backend'
          service: 'client-service'

  # Case Service
  - job_name: 'case-service'
    metrics_path: '/case-service/actuator/prometheus'
    static_configs:
      - targets: ['case-service:8300']
        labels:
          group: 'carrillo-backend'
          service: 'case-service'

  # Payment Service (no context-path)
  - job_name: 'payment-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['payment-service:8400']
        labels:
          group: 'carrillo-backend'
          service: 'payment-service'

  # Document Service (no context-path)
  - job_name: 'document-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['document-service:8500']
        labels:
          group: 'carrillo-backend'
          service: 'document-service'

  # Calendar Service (no context-path)
  - job_name: 'calendar-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['calendar-service:8600']
        labels:
          group: 'carrillo-backend'
          service: 'calendar-service'

  # Notification Service (no context-path)
  - job_name: 'notification-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['notification-service:8700']
        labels:
          group: 'carrillo-backend'
          service: 'notification-service'

  # N8N Integration Service
  - job_name: 'n8n-integration-service'
    metrics_path: '/n8n-integration-service/actuator/prometheus'
    static_configs:
      - targets: ['n8n-integration-service:8800']
        labels:
          group: 'carrillo-backend'
          service: 'n8n-integration-service'

  # NATS monitoring (uses /varz endpoint - JSON, not Prometheus format)
  # Disabled because NATS /varz returns JSON, not Prometheus metrics
  # To enable NATS metrics, use nats-exporter sidecar
  # - job_name: 'nats'
  #   metrics_path: '/varz'
  #   static_configs:
  #     - targets: ['nats:8222']
  #       labels:
  #         group: 'messaging'

  # Grafana LGTM Stack
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']

  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']

  - job_name: 'tempo'
    static_configs:
      - targets: ['tempo:3200']

  - job_name: 'mimir'
    static_configs:
      - targets: ['mimir:9009']
