# ===========================================
# ðŸ” Carrillo Abogados - Security Scan Pipeline
# ===========================================
# Snyk + SonarCloud + Trivy Integration
# Triggers: push/PR to main, staging
# ===========================================

name: ðŸ” Security Scan

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  schedule:
    # Run security scan every Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch: # Allow manual trigger

env:
  JAVA_VERSION: '21'

jobs:
  # =========================================
  # ðŸ›¡ï¸ SNYK - Vulnerability Scanning
  # =========================================
  snyk-scan:
    name: ðŸ›¡ï¸ Snyk Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: ðŸ›¡ï¸ Run Snyk to check for vulnerabilities
      uses: snyk/actions/maven@master
      continue-on-error: true # Don't fail the build, report only
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --all-projects

    - name: ðŸ›¡ï¸ Run Snyk to check for code vulnerabilities
      uses: snyk/actions/maven@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        command: code test
        args: --severity-threshold=high

    - name: ðŸ“Š Upload Snyk results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: snyk.sarif
      continue-on-error: true

  # =========================================
  # ðŸ“Š SONARCLOUD - Code Quality Analysis
  # =========================================
  sonarcloud:
    name: ðŸ“Š SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Shallow clones disabled for better relevancy

    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: ðŸ“¦ Build with Maven (generate coverage)
      run: ./mvnw clean verify -T 1C -B -Pcoverage
      continue-on-error: true

    - name: ðŸ“Š SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=AlexisJ16_CarrilloAbogados
          -Dsonar.organization=alexisj16
          -Dsonar.java.binaries=**/target/classes
          -Dsonar.coverage.jacoco.xmlReportPaths=**/target/site/jacoco/jacoco.xml
          -Dsonar.exclusions=**/target/**,**/node_modules/**,**/*.min.js,**/*.min.css

  # =========================================
  # ðŸ³ TRIVY - Container Security
  # =========================================
  trivy-scan:
    name: ðŸ³ Trivy Container Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Run Trivy vulnerability scanner (filesystem)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
        severity: 'HIGH,CRITICAL'
        ignore-unfixed: true

    - name: ðŸ“¤ Upload Trivy FS results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-fs-results.sarif'
        category: 'trivy-filesystem'

    - name: ðŸ” Run Trivy config scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: '.'
        format: 'table'
        severity: 'HIGH,CRITICAL'
      continue-on-error: true

  # =========================================
  # ðŸ•·ï¸ OWASP ZAP - DAST (Optional)
  # =========================================
  # owasp-zap:
  #   name: ðŸ•·ï¸ OWASP ZAP Scan
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'workflow_dispatch'
  #   
  #   steps:
  #   - name: OWASP ZAP Baseline Scan
  #     uses: zaproxy/action-baseline@v0.10.0
  #     with:
  #       target: 'https://staging.carrilloabgd.com'
  #       rules_file_name: '.zap/rules.tsv'

  # =========================================
  # ðŸ“‹ SECURITY SUMMARY
  # =========================================
  security-summary:
    name: ðŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [snyk-scan, sonarcloud, trivy-scan]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Security Summary
      run: |
        echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ›¡ï¸ Snyk | ${{ needs.snyk-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“Š SonarCloud | ${{ needs.sonarcloud.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ³ Trivy | ${{ needs.trivy-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Snyk Dashboard](https://app.snyk.io/org/alexisj16)" >> $GITHUB_STEP_SUMMARY
        echo "- [SonarCloud Dashboard](https://sonarcloud.io/project/overview?id=AlexisJ16_CarrilloAbogados)" >> $GITHUB_STEP_SUMMARY
        echo "- [GitHub Security Tab](https://github.com/AlexisJ16/CarrilloAbogados/security)" >> $GITHUB_STEP_SUMMARY
