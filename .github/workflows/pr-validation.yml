# ===========================================
# ğŸ›ï¸ Carrillo Abogados - PR Validation
# ===========================================
# Quick validation for Pull Requests
# Runs: Build (no Docker push)
# ===========================================

name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  JAVA_VERSION: '21'

jobs:
  validate:
    name: ğŸ” Validate PR
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ï¿½ Make Maven Wrapper executable
      run: chmod +x ./mvnw
    
    - name: ï¿½ğŸ“¦ Build with Maven (skip slow tests)
      run: ./mvnw clean verify -T 1C -B -DskipITs
    
    - name: ğŸ“Š Generate PR Summary
      if: always()
      run: |
        echo "## ğŸ” PR Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count changed files by type
        echo "### ğŸ“ Files Changed" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  lint-commits:
    name: ğŸ“ Lint Commit Messages
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“ Check commit messages
      run: |
        echo "Checking commit message format..."
        COMMITS=$(git log --format="%s" origin/${{ github.base_ref }}..HEAD)
        
        while IFS= read -r commit; do
          if [[ ! "$commit" =~ ^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\(.+\))?: ]]; then
            echo "âš ï¸ Commit doesn't follow conventional format: $commit"
            echo "Expected format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, test, chore, build, ci, perf, revert"
          else
            echo "âœ… $commit"
          fi
        done <<< "$COMMITS"
