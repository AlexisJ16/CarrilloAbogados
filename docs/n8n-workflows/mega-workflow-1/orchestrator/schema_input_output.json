{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Workflow Orquestador - Schemas de Input/Output",
  "description": "Definición formal de estructuras de datos para WORKFLOW A: Lead Lifecycle Manager",
  "version": "2.0",
  "date": "2026-01-02",

  "definitions": {

    "orchestratorInput": {
      "title": "Input del Webhook Principal",
      "description": "Payload recibido por /lead-events",
      "type": "object",
      "oneOf": [
        { "$ref": "#/definitions/newLeadEvent" },
        { "$ref": "#/definitions/emailEvent" },
        { "$ref": "#/definitions/meetingEvent" },
        { "$ref": "#/definitions/nurturingEvent" }
      ]
    },

    "newLeadEvent": {
      "title": "Evento: Nuevo Lead",
      "type": "object",
      "required": ["event_type", "email"],
      "properties": {
        "event_type": {
          "type": "string",
          "const": "new_lead",
          "description": "Tipo de evento"
        },
        "nombre": {
          "type": "string",
          "minLength": 1,
          "description": "Nombre completo del lead"
        },
        "email": {
          "type": "string",
          "format": "email",
          "description": "Email del lead (requerido)"
        },
        "telefono": {
          "type": "string",
          "pattern": "^\\+?[1-9]\\d{1,14}$",
          "description": "Teléfono en formato internacional (opcional)"
        },
        "empresa": {
          "type": "string",
          "description": "Nombre de la empresa (opcional)"
        },
        "cargo": {
          "type": "string",
          "description": "Cargo en la empresa (opcional)"
        },
        "servicio_interes": {
          "type": "string",
          "description": "Servicio de interés (opcional)"
        },
        "mensaje": {
          "type": "string",
          "description": "Mensaje del lead (opcional)"
        },
        "utm_source": {
          "type": "string",
          "description": "Fuente de tráfico (opcional)"
        },
        "utm_campaign": {
          "type": "string",
          "description": "Campaña de marketing (opcional)"
        },
        "utm_medium": {
          "type": "string",
          "description": "Medio de tráfico (opcional)"
        },
        "utm_term": {
          "type": "string",
          "description": "Término de búsqueda (opcional)"
        },
        "utm_content": {
          "type": "string",
          "description": "Contenido de anuncio (opcional)"
        }
      },
      "additionalProperties": false
    },

    "emailEvent": {
      "title": "Evento: Email Interaction",
      "type": "object",
      "required": ["event_type", "lead_id", "email"],
      "properties": {
        "event_type": {
          "type": "string",
          "enum": ["email_opened", "email_clicked", "email_bounced", "email_unsubscribed"],
          "description": "Tipo de interacción con email"
        },
        "lead_id": {
          "type": "string",
          "description": "ID del lead en Firestore"
        },
        "email": {
          "type": "string",
          "format": "email",
          "description": "Email del lead"
        },
        "mailersend_event": {
          "type": "string",
          "description": "Evento original de Mailersend"
        },
        "campaign_id": {
          "type": "string",
          "description": "ID de la campaña de email"
        },
        "email_id": {
          "type": "string",
          "description": "ID del email específico"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp del evento"
        },
        "ip_address": {
          "type": "string",
          "description": "IP del usuario (opcional)"
        },
        "user_agent": {
          "type": "string",
          "description": "User agent del navegador (opcional)"
        }
      },
      "additionalProperties": false
    },

    "meetingEvent": {
      "title": "Evento: Reunión Agendada",
      "type": "object",
      "required": ["event_type", "email"],
      "properties": {
        "event_type": {
          "type": "string",
          "enum": ["meeting_booked", "meeting_cancelled", "meeting_rescheduled"],
          "description": "Tipo de evento de reunión"
        },
        "lead_id": {
          "type": "string",
          "description": "ID del lead en Firestore (opcional si es primera reunión)"
        },
        "email": {
          "type": "string",
          "format": "email",
          "description": "Email del invitado"
        },
        "meeting_start": {
          "type": "string",
          "format": "date-time",
          "description": "Inicio de la reunión"
        },
        "meeting_end": {
          "type": "string",
          "format": "date-time",
          "description": "Fin de la reunión"
        },
        "meeting_link": {
          "type": "string",
          "format": "uri",
          "description": "Link a la reunión (Zoom/Google Meet)"
        },
        "calendly_event": {
          "type": "string",
          "description": "Tipo de evento de Calendly"
        },
        "event_id": {
          "type": "string",
          "description": "ID del evento en Calendly"
        },
        "invitee_name": {
          "type": "string",
          "description": "Nombre del invitado"
        }
      },
      "additionalProperties": false
    },

    "nurturingEvent": {
      "title": "Evento: Trigger de Nurturing",
      "type": "object",
      "required": ["event_type"],
      "properties": {
        "event_type": {
          "type": "string",
          "const": "nurturing_trigger",
          "description": "Trigger manual de nurturing"
        },
        "batch_size": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 50,
          "description": "Cantidad de leads a procesar en este batch"
        },
        "filter_category": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["HOT", "WARM", "COLD"]
          },
          "description": "Filtrar por categoría (opcional)"
        }
      },
      "additionalProperties": false
    },

    "orchestratorOutput": {
      "title": "Output del Webhook Principal",
      "description": "Respuesta del orquestador al cliente del webhook",
      "type": "object",
      "required": ["success", "event_type", "sub_workflow_executed"],
      "properties": {
        "success": {
          "type": "boolean",
          "description": "Indica si la ejecución fue exitosa"
        },
        "event_type": {
          "type": "string",
          "description": "Tipo de evento procesado"
        },
        "sub_workflow_executed": {
          "type": "string",
          "description": "ID del sub-workflow que procesó el evento"
        },
        "execution_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Tiempo total de ejecución en milisegundos"
        },
        "orchestrator_execution_id": {
          "type": "string",
          "description": "ID de ejecución del orquestador (para trazabilidad)"
        },
        "orchestrator_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp cuando el orquestador recibió el evento"
        },
        "result": {
          "type": "object",
          "description": "Resultado específico del sub-workflow ejecutado"
        },
        "error": {
          "type": "object",
          "description": "Información del error (solo si success=false)",
          "properties": {
            "type": {
              "type": "string",
              "enum": [
                "validation_error",
                "spoke_execution_error",
                "timeout_error",
                "unknown_event_error",
                "internal_error"
              ]
            },
            "message": {
              "type": "string",
              "description": "Mensaje descriptivo del error"
            },
            "details": {
              "type": "object",
              "description": "Detalles adicionales del error"
            }
          }
        }
      },
      "additionalProperties": false
    },

    "spokeInput": {
      "title": "Input genérico para Spokes",
      "description": "Datos pasados del orquestador a los spokes",
      "type": "object",
      "properties": {
        "orchestrator_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp del orquestador"
        },
        "orchestrator_execution_id": {
          "type": "string",
          "description": "ID de ejecución del orquestador"
        }
      },
      "additionalProperties": true
    },

    "spokeOutput": {
      "title": "Output esperado de todos los Spokes",
      "description": "Estructura estándar de respuesta de spokes",
      "type": "object",
      "required": ["success"],
      "properties": {
        "success": {
          "type": "boolean",
          "description": "Indica si el spoke ejecutó exitosamente"
        },
        "message": {
          "type": "string",
          "description": "Mensaje descriptivo del resultado"
        },
        "error_message": {
          "type": "string",
          "description": "Mensaje de error (solo si success=false)"
        },
        "error_node": {
          "type": "string",
          "description": "Nombre del nodo que falló (solo si success=false)"
        }
      },
      "additionalProperties": true
    },

    "subAOutput": {
      "title": "Output de SUB-A: Lead Intake & Enrichment",
      "allOf": [
        { "$ref": "#/definitions/spokeOutput" }
      ],
      "properties": {
        "lead_id": {
          "type": "string",
          "description": "ID único del lead en Firestore"
        },
        "score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Score calculado del lead"
        },
        "categoria": {
          "type": "string",
          "enum": ["HOT", "WARM", "COLD"],
          "description": "Categoría del lead"
        },
        "email_sent": {
          "type": "boolean",
          "description": "Indica si se envió email al lead"
        },
        "notification_sent": {
          "type": "boolean",
          "description": "Indica si se notificó al equipo (solo HOT)"
        }
      }
    },

    "subEOutput": {
      "title": "Output de SUB-E: Engagement Tracker",
      "allOf": [
        { "$ref": "#/definitions/spokeOutput" }
      ],
      "properties": {
        "lead_id": {
          "type": "string",
          "description": "ID del lead en Firestore"
        },
        "engagement_updated": {
          "type": "boolean",
          "description": "Indica si se actualizó el engagement"
        },
        "score_increased": {
          "type": "boolean",
          "description": "Indica si aumentó el score"
        },
        "category_changed": {
          "type": "boolean",
          "description": "Indica si cambió la categoría"
        },
        "new_category": {
          "type": "string",
          "enum": ["HOT", "WARM", "COLD"],
          "description": "Nueva categoría (solo si cambió)"
        }
      }
    },

    "subFOutput": {
      "title": "Output de SUB-F: Meeting Scheduler",
      "allOf": [
        { "$ref": "#/definitions/spokeOutput" }
      ],
      "properties": {
        "lead_id": {
          "type": "string",
          "description": "ID del lead en Firestore"
        },
        "meeting_scheduled": {
          "type": "boolean",
          "description": "Indica si se agendó la reunión"
        },
        "meeting_date": {
          "type": "string",
          "format": "date-time",
          "description": "Fecha de la reunión"
        },
        "notification_sent": {
          "type": "boolean",
          "description": "Indica si se notificó al equipo"
        }
      }
    },

    "subDOutput": {
      "title": "Output de SUB-D: Nurturing Sequence",
      "allOf": [
        { "$ref": "#/definitions/spokeOutput" }
      ],
      "properties": {
        "leads_processed": {
          "type": "integer",
          "minimum": 0,
          "description": "Cantidad de leads procesados en batch"
        },
        "emails_sent": {
          "type": "integer",
          "minimum": 0,
          "description": "Cantidad de emails enviados"
        },
        "emails_failed": {
          "type": "integer",
          "minimum": 0,
          "description": "Cantidad de emails que fallaron"
        },
        "execution_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Tiempo de ejecución del batch"
        }
      }
    }
  },

  "examples": {
    "newLeadRequest": {
      "event_type": "new_lead",
      "nombre": "María Rodríguez",
      "email": "maria@techstartup.co",
      "telefono": "+573101234567",
      "empresa": "TechStartup SAS",
      "cargo": "CEO",
      "servicio_interes": "Registro de Marca",
      "mensaje": "Necesitamos proteger nuestra marca de software",
      "utm_source": "google",
      "utm_campaign": "registro-marca-q1-2026"
    },

    "emailOpenedRequest": {
      "event_type": "email_opened",
      "lead_id": "2026-01-15T10:30:00.000Z-maria-techstartup-co",
      "email": "maria@techstartup.co",
      "mailersend_event": "email.opened",
      "campaign_id": "nurture-sequence-1",
      "email_id": "msg_abc123",
      "timestamp": "2026-01-16T08:45:00.000Z"
    },

    "meetingBookedRequest": {
      "event_type": "meeting_booked",
      "email": "maria@techstartup.co",
      "meeting_start": "2026-01-20T10:00:00.000Z",
      "meeting_end": "2026-01-20T11:00:00.000Z",
      "meeting_link": "https://meet.google.com/abc-defg-hij",
      "calendly_event": "invitee.created",
      "event_id": "calendly_123456",
      "invitee_name": "María Rodríguez"
    },

    "successResponse": {
      "success": true,
      "event_type": "new_lead",
      "sub_workflow_executed": "RHj1TAqBazxNFriJ",
      "execution_time_ms": 3542,
      "orchestrator_execution_id": "exec_abc123",
      "orchestrator_timestamp": "2026-01-15T10:30:00.000Z",
      "result": {
        "success": true,
        "lead_id": "2026-01-15T10:30:00.000Z-maria-techstartup-co",
        "score": 95,
        "categoria": "HOT",
        "email_sent": true,
        "notification_sent": true,
        "message": "Lead procesado exitosamente por SUB-A"
      }
    },

    "errorResponse": {
      "success": false,
      "event_type": "new_lead",
      "sub_workflow_executed": "RHj1TAqBazxNFriJ",
      "execution_time_ms": 1203,
      "orchestrator_execution_id": "exec_xyz789",
      "orchestrator_timestamp": "2026-01-15T11:00:00.000Z",
      "result": null,
      "error": {
        "type": "spoke_execution_error",
        "message": "Failed to save lead to Firestore",
        "details": {
          "error_node": "4. Guardar en Firestore",
          "error_code": "PERMISSION_DENIED"
        }
      }
    },

    "validationErrorResponse": {
      "success": false,
      "event_type": "error",
      "sub_workflow_executed": null,
      "execution_time_ms": 50,
      "orchestrator_execution_id": "exec_err001",
      "orchestrator_timestamp": "2026-01-15T12:00:00.000Z",
      "result": null,
      "error": {
        "type": "validation_error",
        "message": "Invalid email format",
        "details": {
          "field": "email",
          "value": "not-an-email",
          "expected": "Valid email address"
        }
      }
    }
  }
}
