# ğŸ¨ WIREFRAME MW#1 v3.0 - Arquitectura Visual

**MetodologÃ­a**: Excalidraw-style Mapping (Nate Herk)
**PropÃ³sito**: Manual de instrucciones visual antes de construir en n8n
**Fecha**: 6 de Enero, 2026

---

## ğŸ—ï¸ VISTA GENERAL DEL SISTEMA

```
                                 CARRILLO ABOGADOS
                            LEAD LIFECYCLE AUTOMATION
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                            FUENTES EXTERNAS                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  PORTAL    â”‚  â”‚ MAILERSEND â”‚  â”‚   GOOGLE   â”‚  â”‚   MANUAL   â”‚           â”‚
â”‚  â”‚    WEB     â”‚  â”‚  WEBHOOKS  â”‚  â”‚  CALENDAR  â”‚  â”‚  TRIGGER   â”‚           â”‚
â”‚  â”‚ /contacto  â”‚  â”‚  (opens/   â”‚  â”‚  (reuniÃ³n  â”‚  â”‚ (nurturing)â”‚           â”‚
â”‚  â”‚            â”‚  â”‚   clicks)  â”‚  â”‚  agendada) â”‚  â”‚            â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                â”‚                â”‚                â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                   â–¼                                         â”‚
â”‚                         POST /webhook/lead-events                           â”‚
â”‚                                   â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                   ORQUESTADOR (AI AGENT - PADRE)                       â•‘
    â•‘                        [Nivel 4: AI Agent]                             â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                                        â•‘
    â•‘  [1] Webhook Principal                                                 â•‘
    â•‘       â†“                                                                â•‘
    â•‘  [2] AI Agent Node                                                     â•‘
    â•‘       â€¢ LLM: Google Gemini 2.5 Pro                                     â•‘
    â•‘       â€¢ Memory: Window Buffer (Ãºltimos 5 eventos)                      â•‘
    â•‘       â€¢ MaxIterations: 3                                               â•‘
    â•‘       â€¢ ReturnIntermediateSteps: true                                  â•‘
    â•‘       â†“                                                                â•‘
    â•‘  [3] Respond to Webhook (HTTP 200)                                     â•‘
    â•‘       â†“                                                                â•‘
    â•‘  [4] Logger: Google Sheets                                             â•‘
    â•‘       (Track: event_type, tool_used, tokens, latency, timestamp)       â•‘
    â•‘                                                                        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚                         â”‚
          â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  TOOL 1  â”‚              â”‚  TOOL 2  â”‚              â”‚  TOOL 3  â”‚
    â”‚  SUB-A   â”‚              â”‚  SUB-D   â”‚              â”‚  SUB-E   â”‚
    â”‚  Intake  â”‚              â”‚Nurturing â”‚              â”‚Engagementâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚                         â”‚
          â–¼                         â–¼                         â–¼
    [AI Workflow]             [AI Workflow]           [Pure Logic]
    Nivel 3                   Nivel 3                 Nivel 2
```

---

## ğŸ“Š DECISIÃ“N TREE DEL AI AGENT

```
                         PAYLOAD RECIBIDO
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  AI AGENT ANALIZA      â”‚
                    â”‚  event_type + context  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚                        â”‚
        â–¼                        â–¼                        â–¼
    "new_lead"          "email_opened"          "nurturing_manual"
    "email_clicked"     "meeting_booked"
        â”‚                        â”‚                        â”‚
        â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SUB-A       â”‚       â”‚   SUB-E       â”‚       â”‚   SUB-D       â”‚
â”‚  Lead Intake  â”‚       â”‚  Engagement   â”‚       â”‚  Nurturing    â”‚
â”‚               â”‚       â”‚   Tracker     â”‚       â”‚   Engine      â”‚
â”‚  Validar      â”‚       â”‚  Parse event  â”‚       â”‚  Batch        â”‚
â”‚  Scoring IA   â”‚       â”‚  Update score â”‚       â”‚  process      â”‚
â”‚  Guardar      â”‚       â”‚  Callback DB  â”‚       â”‚  10 leads     â”‚
â”‚  Notificar    â”‚       â”‚               â”‚       â”‚               â”‚
â”‚  Responder    â”‚       â”‚               â”‚       â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ SUB-D: NURTURING SEQUENCE - FLUJO DETALLADO

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘             SUB-D: NURTURING SEQUENCE ENGINE                          â•‘
â•‘                   [Nivel 3: AI Workflow]                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TRIGGER                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [1] Schedule Trigger                                            â”‚  â”‚
â”‚  â”‚      â€¢ Cron: 0 */6 * * * (cada 6 horas)                          â”‚  â”‚
â”‚  â”‚      â€¢ Timezone: America/Bogota                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PREPARACIÃ“N                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [2] Calcular Timestamp                                          â”‚  â”‚
â”‚  â”‚      Code: const now = new Date().toISOString()                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QUERY LEADS                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [3] Firestore Query                                             â”‚  â”‚
â”‚  â”‚      Collection: leads                                           â”‚  â”‚
â”‚  â”‚      Where:                                                      â”‚  â”‚
â”‚  â”‚        â€¢ status IN ["nuevo", "nurturing"]                        â”‚  â”‚
â”‚  â”‚        â€¢ emails_sent < 12                                        â”‚  â”‚
â”‚  â”‚        â€¢ next_email_date <= NOW                                  â”‚  â”‚
â”‚  â”‚      Order: next_email_date ASC                                  â”‚  â”‚
â”‚  â”‚      Limit: 10                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VALIDACIÃ“N                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [4] IF: Â¿Hay Leads?                                             â”‚  â”‚
â”‚  â”‚      Condition: {{ $json.data.length > 0 }}                      â”‚  â”‚
â”‚  â”‚      â”œâ”€ TRUE â†’ Continuar a Loop                                  â”‚  â”‚
â”‚  â”‚      â””â”€ FALSE â†’ [16] Exit (No hay leads para procesar)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BATCH PROCESSING                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [5] Loop: Split In Batches                                      â”‚  â”‚
â”‚  â”‚      Batch Size: 1 lead at a time                                â”‚  â”‚
â”‚  â”‚      Mode: sequential                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                DENTRO DEL LOOP (por cada lead)                   â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                                  â•‘
    â•‘  [6] Extraer Datos Lead                                          â•‘
    â•‘      Set: lead_id, nombre, email, empresa, servicio,             â•‘
    â•‘           emails_sent, created_at                                â•‘
    â•‘      â†“                                                           â•‘
    â•‘  [7] Calcular PosiciÃ³n en Secuencia                              â•‘
    â•‘      Code: JavaScript                                            â•‘
    â•‘      Input: created_at, emails_sent                              â•‘
    â•‘      Output: position (1-12), days_since_capture, should_send    â•‘
    â•‘      â†“                                                           â•‘
    â•‘  [8] Cargar Template Email                                       â•‘
    â•‘      Code: templates[position]                                   â•‘
    â•‘      Output: subject_template, content_structure, max_words      â•‘
    â•‘      â†“                                                           â•‘
    â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
    â•‘  â”‚         PERSONALIZACIÃ“N CON IA                             â”‚  â•‘
    â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â•‘
    â•‘  â”‚  â”‚  [9] Google Gemini 2.5 Pro                           â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Model: gemini-2.5-pro                           â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Max Tokens: 300                                 â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Temperature: 0.7                                â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      System: "Eres copywriter experto..."           â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Prompt: "Genera email para..."                 â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Output: { subject, body }                       â”‚  â”‚  â•‘
    â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â•‘
    â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
    â•‘      â†“                                                           â•‘
    â•‘  [10] Validar Output Gemini                                      â•‘
    â•‘       Code: Verificar subject + body no vacÃ­os                   â•‘
    â•‘      â†“                                                           â•‘
    â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
    â•‘  â”‚         ENVÃO DE EMAIL                                     â”‚  â•‘
    â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â•‘
    â•‘  â”‚  â”‚  [11] Mailersend HTTP Request                        â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      POST https://api.mailersend.com/v1/email       â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      From: marketing@carrilloabgd.com                â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      To: {{ $json.email }}                           â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Subject: {{ $json.subject }}                    â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Body: {{ $json.body }}                          â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Tags: ["nurturing", "pos-{{ position }}"]       â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Tracking: opens=true, clicks=true               â”‚  â”‚  â•‘
    â•‘  â”‚  â”‚      Retry: 3 attempts, 1s wait                      â”‚  â”‚  â•‘
    â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â•‘
    â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
    â•‘      â†“                                                           â•‘
    â•‘  [12] IF: Â¿EnvÃ­o Exitoso?                                        â•‘
    â•‘       Condition: statusCode === 200 OR 202                       â•‘
    â•‘       â”œâ”€ TRUE â†’ [13] Actualizar Firestore                        â•‘
    â•‘       â””â”€ FALSE â†’ [15] Registrar Error                            â•‘
    â•‘      â†“                                                           â•‘
    â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
    â•‘  â”‚  [13] Firestore Update                                     â”‚  â•‘
    â•‘  â”‚      Collection: leads                                     â”‚  â•‘
    â•‘  â”‚      Document ID: {{ $json.lead_id }}                      â”‚  â•‘
    â•‘  â”‚      Update:                                               â”‚  â•‘
    â•‘  â”‚        emails_sent: {{ $json.emails_sent + 1 }}            â”‚  â•‘
    â•‘  â”‚        last_contact: NOW                                   â”‚  â•‘
    â•‘  â”‚        status: "nurturing"                                 â”‚  â•‘
    â•‘  â”‚        nurturing_position: {{ $json.position }}            â”‚  â•‘
    â•‘  â”‚        next_email_date: NOW + X dÃ­as                       â”‚  â•‘
    â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
    â•‘      â†“                                                           â•‘
    â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
    â•‘  â”‚  [14] Callback a Backend (OPCIONAL)                        â”‚  â•‘
    â•‘  â”‚      POST {{ $env.BACKEND_URL }}/webhook/nurturing-sent    â”‚  â•‘
    â•‘  â”‚      Body: { lead_id, position, sent_at, status }          â”‚  â•‘
    â•‘  â”‚      onError: continueRegularOutput (no bloquea flujo)     â”‚  â•‘
    â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
    â•‘                                                                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FINALIZACIÃ“N                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [15] Consolidar Resultados                                      â”‚  â”‚
â”‚  â”‚      Set: total_leads_processed, total_sent, total_errors        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [16] Exit Workflow                                              â”‚  â”‚
â”‚  â”‚      Return: { success, summary }                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“… LÃ“GICA DE SCHEDULING (CRÃTICA)

```
LEAD CAPTURADO EN FIRESTORE
    â†“
created_at: 2026-01-06T10:00:00Z
emails_sent: 0
next_email_date: NULL
    â†“
SUB-A ejecuta (primera vez)
    â†“
Actualiza Firestore:
  emails_sent: 0
  next_email_date: 2026-01-09T00:00:00Z  (+ 3 dÃ­as)
  status: "nuevo"
    â†“
SUB-D corre cada 6 horas (00:00, 06:00, 12:00, 18:00)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QUERY: WHERE next_email_date <= NOW AND emails_sent < 12          â”‚
â”‚                                                                     â”‚
â”‚  Ejemplo (ahora es 2026-01-09T12:00:00Z):                          â”‚
â”‚                                                                     â”‚
â”‚  Lead A: next_email_date = 2026-01-09T00:00:00Z âœ… MATCH           â”‚
â”‚  Lead B: next_email_date = 2026-01-10T00:00:00Z âŒ NO MATCH        â”‚
â”‚                                                                     â”‚
â”‚  Lead A entra al batch processing                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Nodo 7: Calcular PosiciÃ³n
    â†“
days_since_capture = 3
emails_sent = 0
    â†“
Busca en emailSchedule:
  position 2: minDay=3, maxDay=5 âœ… MATCH
    â†“
position = 2
should_send = true (porque emails_sent < position)
    â†“
Nodo 8: Cargar Template Email #2
    â†“
Nodo 9: Gemini personaliza
    â†“
Nodo 11: Mailersend envÃ­a
    â†“
Nodo 13: Actualiza Firestore:
  emails_sent: 1
  next_email_date: 2026-01-13T00:00:00Z  (+ 4 dÃ­as para pos 3)
  nurturing_position: 2
```

### Mapeo de DÃ­as a next_email_date

```javascript
// DespuÃ©s de enviar email en posiciÃ³n X, calcular siguiente fecha
const nextEmailDelays = {
  1: 3,   // DespuÃ©s de pos 1, esperar 3 dÃ­as â†’ pos 2 (dÃ­a 3)
  2: 4,   // DespuÃ©s de pos 2, esperar 4 dÃ­as â†’ pos 3 (dÃ­a 7)
  3: 3,   // DespuÃ©s de pos 3, esperar 3 dÃ­as â†’ pos 4 (dÃ­a 10)
  4: 4,   // DespuÃ©s de pos 4, esperar 4 dÃ­as â†’ pos 5 (dÃ­a 14)
  5: 7,   // DespuÃ©s de pos 5, esperar 7 dÃ­as â†’ pos 6 (dÃ­a 21)
  6: 7,   // DespuÃ©s de pos 6, esperar 7 dÃ­as â†’ pos 7 (dÃ­a 28)
  7: 7,   // DespuÃ©s de pos 7, esperar 7 dÃ­as â†’ pos 8 (dÃ­a 35)
  8: 7,   // DespuÃ©s de pos 8, esperar 7 dÃ­as â†’ pos 9 (dÃ­a 42)
  9: 7,   // DespuÃ©s de pos 9, esperar 7 dÃ­as â†’ pos 10 (dÃ­a 49)
  10: 7,  // DespuÃ©s de pos 10, esperar 7 dÃ­as â†’ pos 11 (dÃ­a 56)
  11: 34, // DespuÃ©s de pos 11, esperar 34 dÃ­as â†’ pos 12 (dÃ­a 90)
  12: null // Fin de secuencia
};

// En nodo 13 (Firestore Update):
const currentPosition = $json.position;
const delay = nextEmailDelays[currentPosition];
const nextDate = delay ? new Date(Date.now() + delay * 24 * 60 * 60 * 1000) : null;
```

---

## ğŸ” MANEJO DE ERRORES

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ERROR HANDLING STRATEGY                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ERROR EN GEMINI (Nodo 9)
    â†“
Â¿QuÃ© pasÃ³?
  â€¢ Timeout (> 30s)
  â€¢ Rate limit
  â€¢ Respuesta malformada
    â†“
ACCIÃ“N:
  â”œâ”€ Retry automÃ¡tico (n8n): 2 intentos, 5s wait
  â”‚
  â””â”€ Si falla 3 veces:
      â”œâ”€ Registrar en Firestore collection "errors"
      â”œâ”€ Usar template genÃ©rico sin personalizaciÃ³n
      â””â”€ Continuar flujo (enviar email genÃ©rico)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ERROR EN MAILERSEND (Nodo 11)
    â†“
Â¿QuÃ© pasÃ³?
  â€¢ Email invÃ¡lido (bounce)
  â€¢ API error 500
  â€¢ Rate limit (free tier)
    â†“
ACCIÃ“N:
  â”œâ”€ Retry automÃ¡tico: 3 intentos, 1s wait
  â”‚
  â””â”€ Si falla 3 veces:
      â”œâ”€ Nodo 12 (IF) detecta statusCode !== 200
      â”œâ”€ NO actualizar Firestore (next_email_date sin cambio)
      â”œâ”€ Registrar error en collection "failed_emails"
      â””â”€ Lead serÃ¡ reintentado en siguiente ejecuciÃ³n SUB-D

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ERROR EN FIRESTORE UPDATE (Nodo 13)
    â†“
Â¿QuÃ© pasÃ³?
  â€¢ Network timeout
  â€¢ Permissions error
    â†“
ACCIÃ“N:
  â”œâ”€ Retry automÃ¡tico: 2 intentos
  â”‚
  â””â”€ Si falla 2 veces:
      â”œâ”€ Email YA fue enviado (no se puede deshacer)
      â”œâ”€ Registrar en "firestore_update_errors"
      â”œâ”€ Alert a ingenieria@carrilloabgd.com
      â””â”€ Requiere reconciliaciÃ³n manual

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ERROR EN CALLBACK BACKEND (Nodo 14)
    â†“
Â¿QuÃ© pasÃ³?
  â€¢ Backend no disponible
  â€¢ URL incorrecta
    â†“
ACCIÃ“N:
  â”œâ”€ onError: continueRegularOutput
  â”œâ”€ NO bloquea el flujo
  â”œâ”€ Log en Google Sheets
  â””â”€ Backend se sincronizarÃ¡ en prÃ³ximo poll de Firestore
```

---

## ğŸ“Š TRACKING Y OBSERVABILIDAD

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LOGGER: GOOGLE SHEETS (Orquestador)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Columnas:                                                              â”‚
â”‚  â€¢ timestamp                                                            â”‚
â”‚  â€¢ event_type                                                           â”‚
â”‚  â€¢ tool_used (SUB-A | SUB-D | SUB-E | SUB-F)                            â”‚
â”‚  â€¢ decision_reason                                                      â”‚
â”‚  â€¢ tokens_used                                                          â”‚
â”‚  â€¢ latency_ms                                                           â”‚
â”‚  â€¢ execution_status (success | error)                                   â”‚
â”‚  â€¢ error_message (if applicable)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LOGGER: FIRESTORE COLLECTIONS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ leads (main)                                                         â”‚
â”‚  â€¢ errors (Gemini/Mailersend failures)                                  â”‚
â”‚  â€¢ failed_emails (envÃ­os fallidos)                                      â”‚
â”‚  â€¢ firestore_update_errors (reconciliaciÃ³n manual)                      â”‚
â”‚  â€¢ nurturing_log (cada email enviado con metadata)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MAILERSEND TRACKING                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tags por email:                                                        â”‚
â”‚  â€¢ "nurturing"                                                          â”‚
â”‚  â€¢ "position-X" (1-12)                                                  â”‚
â”‚  â€¢ "mw1-sub-d"                                                          â”‚
â”‚                                                                         â”‚
â”‚  Webhooks (SUB-E futuro):                                               â”‚
â”‚  â€¢ email.opened â†’ Update Firestore: email_opens++                       â”‚
â”‚  â€¢ email.clicked â†’ Update Firestore: email_clicks++, score += 5         â”‚
â”‚  â€¢ email.bounced â†’ Update status: "invalid_email"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ PUNTOS DE DECISIÃ“N CRÃTICOS

### 1. Â¿CuÃ¡ndo usar AI Agent vs AI Workflow?

```
ORQUESTADOR
  â†“
Pregunta: Â¿La secuencia de pasos es predecible?
  â”œâ”€ NO â†’ AI Agent (Nivel 4)
  â”‚   Ejemplo: No sabemos quÃ© tool ejecutar hasta leer el payload
  â”‚
  â””â”€ SÃ â†’ AI Workflow (Nivel 3) o Pure Logic (Nivel 2)
      Ejemplo: Siempre hacemos Query â†’ Loop â†’ Gemini â†’ Mailersend â†’ Update
```

### 2. Â¿CuÃ¡ndo personalizar con IA vs usar template estÃ¡tico?

```
COSTO-BENEFICIO
  â†“
Pregunta: Â¿El valor de personalizaciÃ³n justifica el costo?
  â”œâ”€ SÃ â†’ Usar Gemini ($0.001/email aprox)
  â”‚   â€¢ Nurturing emails (alta conversiÃ³n esperada)
  â”‚   â€¢ Respuesta a leads HOT (personalizaciÃ³n crÃ­tica)
  â”‚
  â””â”€ NO â†’ Template estÃ¡tico
      â€¢ Confirmaciones transaccionales
      â€¢ Emails masivos de bajo valor
```

### 3. Â¿CuÃ¡ndo usar Batch vs Real-time processing?

```
SUB-D: BATCH (cada 6h, 10 leads)
  â†“
Razones:
  â€¢ Costo: Procesar 10 leads juntos vs 10 ejecuciones separadas
  â€¢ Rate limits: Mailersend free tier tiene lÃ­mites/hora
  â€¢ Firestore reads: Batch query mÃ¡s eficiente
  â€¢ Scheduling: Emails se envÃ­an en horarios Ã³ptimos

SUB-A: REAL-TIME (webhook instantÃ¡neo)
  â†“
Razones:
  â€¢ UX: Lead espera respuesta inmediata
  â€¢ Competencia: Responder en < 1 min da ventaja competitiva
  â€¢ Score HOT: NotificaciÃ³n urgente a equipo
```

---

## ğŸ“‹ CHECKLIST DE IMPLEMENTACIÃ“N

### Pre-requisitos

- [ ] Cuenta Mailersend creada y verificada
- [ ] API Key Mailersend guardada en n8n credentials
- [ ] Dominio carrilloabgd.com verificado en Mailersend
- [ ] Variable entorno `BACKEND_URL` configurada en n8n Cloud
- [ ] Google Sheets creada para logging del Orquestador
- [ ] Credencial Google Sheets configurada en n8n

### Fase 1: Orquestador v3.0

- [ ] Backup del Orquestador actual
- [ ] Crear nuevo workflow "Orquestador v3.0"
- [ ] Agregar nodo Webhook Principal
- [ ] Agregar nodo AI Agent (Google Gemini 2.5 Pro)
- [ ] Configurar System Prompt segÃºn specs
- [ ] Conectar SUB-A como Tool
- [ ] Agregar nodo Respond to Webhook
- [ ] Agregar nodo Logger (Google Sheets)
- [ ] Testing con payload `new_lead`
- [ ] Verificar logging funciona

### Fase 2: SUB-D

- [ ] Crear workflow "SUB-D: Nurturing Sequence"
- [ ] Nodo 1: Schedule Trigger (cada 6h)
- [ ] Nodo 2: Calcular timestamp
- [ ] Nodo 3: Firestore Query (leads nurturing)
- [ ] Nodo 4: IF (Â¿hay leads?)
- [ ] Nodo 5: Split In Batches
- [ ] Nodo 6: Extraer datos lead
- [ ] Nodo 7: JavaScript calcular posiciÃ³n
- [ ] Nodo 8: JavaScript cargar template
- [ ] Nodo 9: Gemini personalizaciÃ³n
- [ ] Nodo 10: Validar output Gemini
- [ ] Nodo 11: Mailersend enviar email
- [ ] Nodo 12: IF (Â¿envÃ­o exitoso?)
- [ ] Nodo 13: Firestore update
- [ ] Nodo 14: Callback backend
- [ ] Nodo 15: Consolidar resultados
- [ ] Nodo 16: Exit workflow

### Fase 3: Actualizar SUB-A

- [ ] Modificar nodo Firestore de SUB-A
- [ ] Agregar campo `status: "nuevo"`
- [ ] Agregar campo `emails_sent: 0`
- [ ] Agregar campo `nurturing_position: 1`
- [ ] Agregar campo `next_email_date: now + 3 dÃ­as`
- [ ] Agregar campo `created_at: now`
- [ ] Testing E2E SUB-A

### Fase 4: IntegraciÃ³n

- [ ] Conectar SUB-D como Tool en Orquestador
- [ ] Actualizar System Prompt con reglas SUB-D
- [ ] Testing trigger manual nurturing
- [ ] Verificar logger captura todo
- [ ] Documentar payloads finales

---

**Autor**: Arquitecto n8n
**MetodologÃ­a**: Nate Herk Wireframing
**PrÃ³ximo paso**: Aprobar wireframe â†’ Comenzar implementaciÃ³n
