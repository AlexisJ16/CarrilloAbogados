{
  "name": "SUB-A: Lead Intake (v5 - AI POWERED - COMPATIBLE)",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            { "name": "nombre" },
            { "name": "email" },
            { "name": "telefono" },
            { "name": "empresa" },
            { "name": "cargo" },
            { "name": "servicio_interes" },
            { "name": "mensaje" },
            { "name": "utm_source" },
            { "name": "utm_campaign" }
          ]
        }
      },
      "id": "trigger_sub_a",
      "name": "Execute Workflow Trigger SUB-A",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            { "id": "nombre", "name": "nombre", "type": "string", "value": "={{ $json.nombre }}" },
            { "id": "email", "name": "email", "type": "string", "value": "={{ $json.email }}" },
            { "id": "telefono", "name": "telefono", "type": "string", "value": "={{ $json.telefono }}" },
            { "id": "empresa", "name": "empresa", "type": "string", "value": "={{ $json.empresa }}" },
            { "id": "cargo", "name": "cargo", "type": "string", "value": "={{ $json.cargo }}" },
            { "id": "servicio_interes", "name": "servicio_interes", "type": "string", "value": "={{ $json.servicio_interes }}" },
            { "id": "mensaje", "name": "mensaje", "type": "string", "value": "={{ $json.mensaje }}" },
            { "id": "utm_source", "name": "utm_source", "type": "string", "value": "={{ $json.utm_source }}" },
            { "id": "utm_campaign", "name": "utm_campaign", "type": "string", "value": "={{ $json.utm_campaign }}" }
          ]
        },
        "options": {}
      },
      "id": "map_input",
      "name": "0. Mapear Input del Orquestador",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 300]
    },
    {
      "parameters": {
        "modelId": {
          "mode": "list",
          "value": "gemini-1.5-flash"
        },
        "prompt": "={{ \"Analiza este lead entrante para un bufete de abogados (Carrillo Abogados - PI y Marcas).\n\nDatos del Lead:\n- Nombre: " + $('0. Mapear Input del Orquestador').item.json.nombre + \"\n- Empresa: " + $('0. Mapear Input del Orquestador').item.json.empresa + \"\n- Cargo: " + $('0. Mapear Input del Orquestador').item.json.cargo + \"\n- InterÃ©s declarado: " + $('0. Mapear Input del Orquestador').item.json.servicio_interes + \"\n- Mensaje: " + $('0. Mapear Input del Orquestador').item.json.mensaje + \"\n\nTareas:\n1. Normaliza el servicio de interÃ©s a una de estas categorÃ­as: [Marcas, Patentes, Litigio, Contratos, Corporativo, Otros].\n2. Detecta si es SPAM (true/false).\n3. Calcula un Score (0-100) basado en la calidad de la empresa, cargo y claridad de la necesidad.\n4. Determina la categorÃ­a (HOT si score >= 70, WARM si >= 40, COLD si < 40).\n\nResponde ÃšNICAMENTE con un JSON vÃ¡lido con esta estructura:\n{\n  \"normalized_interest\": \"...\",\n  \"is_spam\": false,\n  \"analysis_reason\": \"...\",\n  \"calculated_score\": 85,\n  \"category\": \"HOT\"\n}" }}",
        "options": {}
      },
      "id": "gemini_analysis",
      "name": "0.5. Analizar Lead (IA)",
      "type": "n8n-nodes-base.googlePalm",
      "typeVersion": 1,
      "position": [680, 160]
    },
    {
      "parameters": {
        "jsCode": "const lead = $('0. Mapear Input del Orquestador').item.json;\nconst analysisText = $('0.5. Analizar Lead (IA)').item.json.text || '{}';\n\nlet analysis = {};\ntry {\n    const jsonMatch = analysisText.match(/\\{Strict\\s*([\\s\\S]*?)\\s*\\}/) || analysisText.match(/\\{[\\s\\S]*\\}/);\n    const jsonStr = jsonMatch ? jsonMatch[0] : analysisText;\n    analysis = JSON.parse(jsonStr);\n} catch (e) {\n    analysis = {\n        normalized_interest: 'Otros',\n        is_spam: false,\n        calculated_score: 30,\n        category: 'COLD',\n        error: e.message\n    };\n}\n\nreturn {\n  json: {\n    ...lead,\n    email_normalized: (lead.email || '').toLowerCase().trim(),\n    score: analysis.calculated_score || 30,\n    categoria: analysis.category || 'COLD',\n    ai_analysis: analysis,\n    lead_id: new Date().toISOString() + '-' + (lead.email || 'no-email').replace(/@/g, '-at-'),\n    processed_at: new Date().toISOString()\n  }\n};"
      },
      "id": "validate_classify",
      "name": "1. Validar y Clasificar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "create",
        "projectId": "carrillo-marketing-core",
        "database": "leads",
        "collection": "leads",
        "columns": "lead_id, nombre, email, empresa, score, categoria, processed_at"
      },
      "id": "firestore_save",
      "name": "2. Guardar en Firestore",
      "type": "n8n-nodes-base.googleFirebaseCloudFirestore",
      "typeVersion": 1.1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "conditions": {
          "combinator": "and",
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.categoria }}",
              "rightValue": "HOT",
              "operator": { "type": "string", "operation": "equals" }
            }
          ]
        }
      },
      "id": "check_hot_if",
      "name": "3. Es Lead HOT? (If)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "subject": "={{ 'ðŸ”¥ HOT LEAD: ' + $json.nombre }}",
        "message": "={{ 'ðŸ”¥ NUEVO LEAD HOT\n\nNombre: ' + $json.nombre + '\nEmail: ' + $json.email + '\nEmpresa: ' + $json.empresa + '\nScore: ' + $json.score + '\nInterÃ©s: ' + $json.servicio_interes + '\nMensaje: ' + $json.mensaje }}",
        "toList": [{ "value": "marketing@carrilloabgd.com" }]
      },
      "id": "notify_team",
      "name": "4. Notificar Equipo (HOT)",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1600, 140]
    },
    {
      "parameters": {
        "modelId": {
          "mode": "list",
          "value": "gemini-1.5-flash"
        },
        "prompt": "={{ \"Genera un email de respuesta personalizado para este lead:\n\nNombre: \" + $json.nombre + \"\nEmpresa: \" + $json.empresa + \"\nInterÃ©s: \" + $json.servicio_interes + \"\nMensaje: \" + $json.mensaje + \"\n\nEl email debe:\n1. Agradecer el contacto\n2. Confirmar que hemos recibido su consulta\n3. Mencionar que el Dr. Omar Carrillo se pondrÃ¡ en contacto pronto\n4. Ser profesional pero cÃ¡lido\n5. Firma: Equipo Carrillo Abogados\n\nResponde SOLO con el texto del email, sin subject.\" }}",
        "options": {}
      },
      "id": "generate_response",
      "name": "5. Generar Respuesta (Gemini)",
      "type": "n8n-nodes-base.googlePalm",
      "typeVersion": 1,
      "position": [1820, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "subject": "ConfirmaciÃ³n de Consulta - Carrillo Abogados",
        "message": "={{ $json.text }}",
        "toList": [{ "value": "={{ $json.email }}" }]
      },
      "id": "send_email",
      "name": "6. Enviar Respuesta Lead",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [2040, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            { "id": "success", "name": "success", "type": "boolean", "value": "true" },
            { "id": "message", "name": "message", "type": "string", "value": "Lead procesado exitosamente por SUB-A (AI Powered)" }
          ]
        }
      },
      "id": "final_result",
      "name": "FINAL. Resultado del Sub-Workflow",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [2260, 300]
    }
  ],
  "connections": {
    "Execute Workflow Trigger SUB-A": {
      "main": [[{ "node": "0. Mapear Input del Orquestador", "type": "main", "index": 0 }]]
    },
    "0. Mapear Input del Orquestador": {
      "main": [[{ "node": "0.5. Analizar Lead (IA)", "type": "main", "index": 0 }]]
    },
    "0.5. Analizar Lead (IA)": {
      "main": [[{ "node": "1. Validar y Clasificar", "type": "main", "index": 0 }]]
    },
    "1. Validar y Clasificar": {
      "main": [[{ "node": "2. Guardar en Firestore", "type": "main", "index": 0 }]]
    },
    "2. Guardar en Firestore": {
      "main": [[{ "node": "3. Es Lead HOT? (If)", "type": "main", "index": 0 }]]
    },
    "3. Es Lead HOT? (If)": {
      "main": [
        [{ "node": "4. Notificar Equipo (HOT)", "type": "main", "index": 0 }],
        [{ "node": "5. Generar Respuesta (Gemini)", "type": "main", "index": 0 }]
      ]
    },
    "4. Notificar Equipo (HOT)": {
      "main": [[{ "node": "5. Generar Respuesta (Gemini)", "type": "main", "index": 0 }]]
    },
    "5. Generar Respuesta (Gemini)": {
      "main": [[{ "node": "6. Enviar Respuesta Lead", "type": "main", "index": 0 }]]
    },
    "6. Enviar Respuesta Lead": {
      "main": [[{ "node": "FINAL. Resultado del Sub-Workflow", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}